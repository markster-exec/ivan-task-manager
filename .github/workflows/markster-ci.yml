name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          pip install ruff black
      - name: Run ruff
        run: ruff check backend/
      - name: Check black formatting
        run: black --check backend/

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
      - name: Run tests
        run: |
          pytest backend/tests/ -v --cov=backend/app --cov-report=term-missing

  build:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t ivan-task-manager:${{ github.sha }} .
      - name: Test container starts
        run: |
          docker run -d --name test-container \
            -e DATABASE_URL=sqlite:///./test.db \
            -e CLICKUP_API_TOKEN=test \
            -e GITHUB_TOKEN=test \
            -e SLACK_BOT_TOKEN=test \
            ivan-task-manager:${{ github.sha }}
          sleep 5
          docker logs test-container
          docker stop test-container
